---

name: tests

on:
  workflow_call:
  push:
    # primary branch build reuses this
    branches-ignore:
      - master

jobs:
  go-tests:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      # use go version number from go.mod
      - name: ğŸ«¶ Get Go version
        run: echo go_version="$(cat go.mod | grep -E '^go ' | grep -o -P '(?<=go ).*')" >> $GITHUB_ENV

      - name: ğŸ¥½ Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: "${{ env.go_version }}"
          cache: true

      - name: ğŸ§± go fmt
        run: test -z $(go fmt ./...)

      - name: â›‘ï¸ go test
        run: go test -v ./...

      - name: ğŸ¦º go build
        run: go build -v ./...

  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“ Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.8.1

      - name: ğŸ—ï¸ Set up chart-testing
        uses: helm/chart-testing-action@v2.2.1

      # ideally would deploy and run against actual environment (EKS)
      # recommended by minikube: https://minikube.sigs.k8s.io/docs/tutorials/setup_minikube_in_github_actions/
      - name: ğŸ’½ Start minikube
        uses: medyagh/setup-minikube@master

      # reuse the makefile target
      - name: ğŸ”§ Build, push and test Docker image on minikube
        run: |
          export SHELL=/bin/bash
          make test-k8s
