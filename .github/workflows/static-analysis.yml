---

name: static-analysis

on:
  workflow_call:
  push:
    # primary branch build reuses this
    branches-ignore:
      - master

jobs:
  # security
  nancy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      # use go version number from go.mod
      - name: ğŸ«¶ Get Go version
        run: echo go_version="$(cat go.mod | grep -E '^go ' | grep -o -P '(?<=go ).*')" >> $GITHUB_ENV

      - name: ğŸ¥½ Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: "${{ env.go_version }}"
          cache: true

      # required for nancy
      - name: âœğŸ½ Write go list
        run: go list -json -m all > go.list

      - name: ğŸ•µï¸â€â™‚ï¸ Nancy
        uses: sonatype-nexus-community/nancy-github-action@main
        with:
          nancyVersion: "v1.0.37"

  # Dockerfile linting
  hadolint:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸ‹ Hadolint
        uses: hadolint/hadolint-action@v2.0.0
        with:
          dockerfile: Dockerfile

  # an all-in-one golang linter
  golangci-lint:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      # use go version number from go.mod
      - name: ğŸ«¶ Get Go version
        run: echo go_version="$(cat go.mod | grep -E '^go ' | grep -o -P '(?<=go ).*')" >> $GITHUB_ENV

      - name: ğŸ¥½ Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: "${{ env.go_version }}"
          cache: true

      - name: ğŸ“¢ golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          version: latest
          skip-go-installation: true
          args: --verbose --allow-parallel-runners --sort-results --print-resources-usage --timeout 5m

  # there's only 1 script (certificates/gen.sh)
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸš Shellcheck
        run: find . -type f \( -name "*.sh" -o -name "*.bash" -o -name "*.ksh" -o -name "*.zsh" \) | xargs --no-run-if-empty shellcheck -x

  # linting helm charts
  chart-testing:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“ Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.9.1

      # python required for linting (yamllint and yamale)
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: ğŸ—ï¸ Set up chart-testing
        uses: helm/chart-testing-action@v2.2.1

      - name: ğŸ‘·â€â™€ï¸ Lint and validate charts
        run: ct lint --all
